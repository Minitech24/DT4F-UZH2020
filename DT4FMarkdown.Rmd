---
title: "DT4F"
author: "Kun Zhang, Ziyun Ni, Ruixuan Zhou, Kevin Hardegger"
date: "1 12 2020"
output:
  html_document: default
  word_document: default
  pdf_document: default
---

**Load the data**
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(error = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# loading libraries
library(xts)
library(PerformanceAnalytics)
library(psych)
library(rollRegres)
library(roll)

# load csv file prices
prices <- read.table("StockPricesDaily.csv",sep = ";", header = TRUE, na = "NA")
date <- as.Date(prices[,1],format="%d.%m.%Y")

prices.ts <- xts(x = prices[,-1], order.by = date)
returns <- Return.calculate(prices = prices.ts, method = 'discrete')

# load csv file betas
Daily_betas <- read.table("Stock_betas_daily.csv",sep = ";", header = TRUE, na = "NA")
date_betas <- as.Date(Daily_betas[,1],format="%d.%m.%Y")
Daily_betas <- xts(x = Daily_betas[,-1], order.by = date_betas)

Daily_betas.ts <- as.matrix(Daily_betas['1994-04-29/2017-12-28'])

Daily_Returns <- as.matrix(returns['1994-04-30/2017-12-29'])
```

```{r Building Portfolios}
# create empty vectors with length = number of periods
P_Returns_P1_daily <- as.matrix(rep(NA,dim(Daily_betas.ts)[1]))
P_Returns_P2_daily <- as.matrix(rep(NA,dim(Daily_betas.ts)[1]))
P_Returns_P3_daily <- as.matrix(rep(NA,dim(Daily_betas.ts)[1]))
P_Returns_P4_daily <- as.matrix(rep(NA,dim(Daily_betas.ts)[1]))
P_Returns_P5_daily <- as.matrix(rep(NA,dim(Daily_betas.ts)[1]))

# create empty vectors with length = number of periods
P_beta_P1_daily <- as.matrix(rep(NA,dim(Daily_betas.ts)[1]))
P_beta_P2_daily <- as.matrix(rep(NA,dim(Daily_betas.ts)[1]))
P_beta_P3_daily <- as.matrix(rep(NA,dim(Daily_betas.ts)[1]))
P_beta_P4_daily <- as.matrix(rep(NA,dim(Daily_betas.ts)[1]))
P_beta_P5_daily <- as.matrix(rep(NA,dim(Daily_betas.ts)[1]))
```


**Average Daily Return of each beta-based ortfolios**
```{r Calculating Returns}
# use a for loop to go through each time period

for (j in 1:dim(Daily_betas.ts)[1])
{
  
  SUB_daily <- Daily_betas.ts[j,]
  
  # divide the stocks contained in SMI into 5 portfolios based on their betas
  P1_P_daily <- subset(SUB_daily,subset = SUB_daily < quantile(SUB_daily , c(0.2),na.rm=TRUE))
  P2_P_daily <- subset(SUB_daily,subset = SUB_daily < quantile(SUB_daily , c(0.4),na.rm=TRUE)& SUB_daily >= quantile(SUB_daily , c(0.2),na.rm=TRUE))
  P3_P_daily <- subset(SUB_daily,subset = SUB_daily < quantile(SUB_daily , c(0.6),na.rm=TRUE)& SUB_daily >= quantile(SUB_daily , c(0.4),na.rm=TRUE))
  P4_P_daily <- subset(SUB_daily,subset = SUB_daily < quantile(SUB_daily , c(0.8),na.rm=TRUE)& SUB_daily >= quantile(SUB_daily , c(0.6),na.rm=TRUE))
  P5_P_daily <- subset(SUB_daily,subset = SUB_daily >= quantile(SUB_daily, c(0.8),na.rm=TRUE))
  
  # calculate the returns of the portfolios of each beta ranked portfolios for every single period
  P_Returns_P1_daily[j] <- mean(Daily_Returns[j,names(P1_P_daily)],na.rm=TRUE)
  P_Returns_P2_daily[j] <- mean(Daily_Returns[j,names(P2_P_daily)],na.rm=TRUE)
  P_Returns_P3_daily[j] <- mean(Daily_Returns[j,names(P3_P_daily)],na.rm=TRUE)
  P_Returns_P4_daily[j] <- mean(Daily_Returns[j,names(P4_P_daily)],na.rm=TRUE)
  P_Returns_P5_daily[j] <- mean(Daily_Returns[j,names(P5_P_daily)],na.rm=TRUE)
  
   # calculate the daily betas of the portfolios of each beta ranked portfolios for every single period
  
  P_beta_P1_daily[j] <- mean(Daily_betas.ts[j,names(P1_P_daily)],na.rm=TRUE)
  P_beta_P2_daily[j] <- mean(Daily_betas.ts[j,names(P2_P_daily)],na.rm=TRUE)
  P_beta_P3_daily[j] <- mean(Daily_betas.ts[j,names(P3_P_daily)],na.rm=TRUE)
  P_beta_P4_daily[j] <- mean(Daily_betas.ts[j,names(P4_P_daily)],na.rm=TRUE)
  P_beta_P5_daily[j] <- mean(Daily_betas.ts[j,names(P5_P_daily)],na.rm=TRUE)
}

# calculate the mean returns of the five beta-sorted portfolios 


mean_return_P1<-mean(P_Returns_P1_daily,na.rm=TRUE)
mean_return_P2<-mean(P_Returns_P2_daily,na.rm=TRUE)
mean_return_P3<-mean(P_Returns_P3_daily,na.rm=TRUE)
mean_return_P4<-mean(P_Returns_P4_daily,na.rm=TRUE)
mean_return_P5<-mean(P_Returns_P5_daily,na.rm=TRUE)

print(mean_return_P1<-mean(P_Returns_P1_daily,na.rm=TRUE))
print(mean_return_P2<-mean(P_Returns_P2_daily,na.rm=TRUE))
print(mean_return_P3<-mean(P_Returns_P3_daily,na.rm=TRUE))
print(mean_return_P4<-mean(P_Returns_P4_daily,na.rm=TRUE))
print(mean_return_P5<-mean(P_Returns_P5_daily,na.rm=TRUE))
```


**Standard Deviation of each beta-based portfolios**
```{r Calculating Standar Deviation}
# calculated the mean standard deviation of the five beta-sorted portfolios

sd_P1<-sd(P_Returns_P1_daily,na.rm=TRUE)
sd_P2<-sd(P_Returns_P2_daily,na.rm=TRUE)
sd_P3<-sd(P_Returns_P3_daily,na.rm=TRUE)
sd_P4<-sd(P_Returns_P4_daily,na.rm=TRUE)
sd_P5<-sd(P_Returns_P5_daily,na.rm=TRUE)

print(sd_P1<-sd(P_Returns_P1_daily,na.rm=TRUE))
print(sd_P2<-sd(P_Returns_P2_daily,na.rm=TRUE))
print(sd_P3<-sd(P_Returns_P3_daily,na.rm=TRUE))
print(sd_P4<-sd(P_Returns_P4_daily,na.rm=TRUE))
print(sd_P5<-sd(P_Returns_P5_daily,na.rm=TRUE))
```


**Line chart of Cumulative Retunrs of each beta-based Portfolios**
```{r, Plotting Results}
# plot results
# calculate cumulative returns of each portfolio
cumulative_returns_p1_monthly <- cumprod(1+P_Returns_P1_daily)
cumulative_returns_p2_monthly <- cumprod(1+P_Returns_P2_daily)
cumulative_returns_p3_monthly <- cumprod(1+P_Returns_P3_daily)
cumulative_returns_p4_monthly <- cumprod(1+P_Returns_P4_daily)
cumulative_returns_p5_monthly <- cumprod(1+P_Returns_P5_daily)

# draw the plot
#png(file="C:/Users/zhour/Desktop/Cumulative Returns.png")
plot(x=date_betas[2:6176], y=cumulative_returns_p1_monthly, ylim=c(0,16),type= "l", lty = 1, lwd = 3, col = "orange", cex.axis = 1, cex.lab = 1, ylab = "Cumulative Return", xlab = "Time")
lines(date_betas[2:6176], cumulative_returns_p2_monthly, lty = 3, lwd = 3, col = "blue")
lines(date_betas[2:6176], cumulative_returns_p3_monthly, lty = 4, lwd = 3, col = "gray")
lines(date_betas[2:6176], cumulative_returns_p4_monthly, lty = 2, lwd = 3, col = "red")
lines(date_betas[2:6176], cumulative_returns_p5_monthly, lty = 1, lwd = 3, col = "black")
legend("topleft", c("Portfolio 1", "Portfolio 2", "Portfolio 3", "Portfolio 4", "Portfolio 5"), 
       lty = c(1,3,4,2,1), lwd = 3, bty = "n",cex = 1.2, col = c("yellow", "blue", "gray","red","black"))
#dev.off()
```

**Line Chart of Developments of each beta-based Portfolios **
```{r, Plotting Results2}
#png(file="C:/Users/zhour/Desktop/daily betas.png")
# draw the plot
plot(x=date_betas[2:6176], y=P_beta_P1_daily, ylim=c(0.1,2.6),type= "l", lty = 1, lwd = 3, col = "orange", cex.axis = 1, cex.lab = 1, ylab = "daily betas", xlab = "Time")
lines(date_betas[2:6176], P_beta_P2_daily, lty = 3, lwd = 3, col = "blue")
lines(date_betas[2:6176], P_beta_P3_daily, lty = 4, lwd = 3, col = "gray")
lines(date_betas[2:6176], P_beta_P4_daily, lty = 2, lwd = 3, col = "red")
lines(date_betas[2:6176], P_beta_P5_daily, lty = 1, lwd = 3, col = "black")
legend("topleft", c("Portfolio 1", "Portfolio 2", "Portfolio 3", "Portfolio 4", "Portfolio 5"), 
       lty = c(1,3,4,2,1), lwd = 3, bty = "n",cex = 1, col = c("orange", "blue", "gray","red","black"))
#dev.off()
```

**Cumulative Return of SMI Index and Swiss Government Bond**
```{r}
# load the monthly swissbond data

swissbond_monthly <- read.csv("Datastream_Swissbond_monthly.csv",sep = ";", header = TRUE, dec = '.')
datebond_monthly <- as.Date(swissbond_monthly$ï..Date,format="%d.%m.%Y")
swissbond_monthly <- xts(swissbond_monthly[,-1], order.by = datebond_monthly)
swissbond_monthly <- swissbond_monthly/100
swissbond_monthly <- (1+swissbond_monthly)^(1/12)-1

# load the monthly SMI Total return data

SMI_monthly <- read.table("SMIMonthly.csv",sep = ";", header = TRUE, na = "NA")
dateSMI_monthly <- as.Date(SMI_monthly$ï..Date,format="%d.%m.%Y")
SMI_monthly <- xts(SMI_monthly[,-1], order.by = dateSMI_monthly)

# calculate the total return of the stocks and the SMI

monthly_total_SMIreturns <- Return.calculate(SMI_monthly)

# calculate cumulative returns of each portfolio
cumulative_returns_swissbond <- cumprod(1+swissbond_monthly$SWISS.CONFEDERATION.BOND.1.YEAR...RED..YIELD['1994-04-29/2017-12-29'])
cumulative_returns_SMI <- cumprod(1+monthly_total_SMIreturns$SMI['1994-04-29/2017-12-29'])

plot(x=datebond_monthly[71:355], y=cumulative_returns_swissbond, ylim=c(0.1,6),type= "l", lty = 1, lwd = 3, col = "red", cex.axis = 1, cex.lab = 1, ylab = "Cumulative Return", xlab = "Time")
lines(datebond_monthly[71:355], cumulative_returns_SMI, lty = 1, lwd = 3, col = "blue")

legend("topleft", c("Swiss Government Bond", "SMI ETF"), 
       lty = c(1,1), lwd = 3, bty = "n",cex = 1.2, col = c("red", "blue"))

```

**Comparison of cumulative returns between each beta-based portfolio and SMI ETF as well as Swiss Government Bonds**
```{r}
#png(file="C:/Users/zhour/Desktop/Cumulative Returns with SMI&SGB.png")
# draw the plot
plot(x=date_betas[2:6176], y=cumulative_returns_p1_monthly, ylim=c(0,16),type= "l", lty = 1, lwd = 3, col = "orange", cex.axis = 1, cex.lab = 1, ylab = "Cumulative Return", xlab = "Time")
lines(date_betas[2:6176], cumulative_returns_p2_monthly, lty = 3, lwd = 3, col = "blue")
lines(date_betas[2:6176], cumulative_returns_p3_monthly, lty = 4, lwd = 3, col = "gray")
lines(date_betas[2:6176], cumulative_returns_p4_monthly, lty = 2, lwd = 3, col = "red")
lines(date_betas[2:6176], cumulative_returns_p5_monthly, lty = 1, lwd = 3, col = "black")
lines(datebond_monthly[71:355], cumulative_returns_swissbond, lty = 1, lwd = 3, col = "purple")
lines(datebond_monthly[71:355], cumulative_returns_SMI, lty = 1, lwd = 3, col = "green")
legend("topleft", c("Portfolio 1", "Portfolio 2", "Portfolio 3", "Portfolio 4", "Portfolio 5","Swiss Bond","SMI ETF"), 
       lty = c(1,3,4,2,1,1,1,1), lwd = 3, bty = "n",cex = 0.9, col = c("orange", "blue", "gray","red","black","purple","green"))
#dev.out()
```


